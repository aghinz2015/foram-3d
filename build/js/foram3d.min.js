var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},Foram3D;!function(t){var e=function(t){function e(e,r,i){this.center=e,this.origin=e,this.radius=r,this.thickness=i;var o=this.buildGeometry(),a=this.buildMaterial();t.call(this,o,a),this.aperture=this.calculateAperture()}return __extends(e,t),e.prototype.setAncestor=function(t){this.ancestor=t,this.origin=t.aperture,t.child=this},e.prototype.showThicknessVector=function(){this.thicknessVector||(this.thicknessVector=this.buildThicknessVector(),this.add(this.thicknessVector)),this.thicknessVector.visible=!0},e.prototype.hideThicknessVector=function(){this.thicknessVector&&(this.thicknessVector.visible=!1)},e.prototype.buildGeometry=function(){var t=new THREE.SphereGeometry(this.radius,e.WIDTH_SEGMENTS,e.HEIGHT_SEGMENTS);return t.applyMatrix((new THREE.Matrix4).makeTranslation(this.center.x,this.center.y,this.center.z)),t},e.prototype.buildMaterial=function(){return new THREE.MeshLambertMaterial({color:16777215,transparent:!0,opacity:.5})},e.prototype.buildThicknessVector=function(){var t=new THREE.Vector3(0,1,0);return new THREE.ArrowHelper(t,this.origin,this.thickness,16776960)},e.prototype.calculateAperture=function(){var t,e,r,i;t=this.geometry.vertices,e=t[0],r=e.distanceTo(this.center);for(var o=1;o<t.length;o++)i=t[o].distanceTo(this.center),r>i&&(e=t[o],r=i);return e},e.WIDTH_SEGMENTS=32,e.HEIGHT_SEGMENTS=32,e}(THREE.Mesh);t.Chamber=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(e){function r(t,r){e.call(this),this.genotype=t,this.material=this.buildMaterial(),this.chambers=[this.buildInitialChamber()],this.currentChamber=this.chambers[0];for(var i=1;r>i;i++)this.evolve()}return __extends(r,e),r.prototype.evolve=function(){var t=this.currentChamber.child;if(t)this.currentChamber=t,this.currentChamber.visible=!0;else{var e=this.calculateNextChamber();this.chambers.push(e),this.currentChamber=e,this.add(e)}},r.prototype.regress=function(){var t=this.currentChamber.ancestor;t&&(this.currentChamber.visible=!1,this.currentChamber=t)},r.prototype.calculateNextChamber=function(){var t,e,r,i,o;return t=this.calculateNewCenter(),e=this.calculateNewRadius(),r=this.calculateNewThickness(),i=this.buildChamber(t,e,r),o=this.calculateNewAperture(i),i.aperture=o,i.setAncestor(this.currentChamber),i},r.prototype.calculateNewCenter=function(){var t,e,r,i,o,a;return t=this.currentChamber.origin,e=this.currentChamber.aperture,r=new THREE.Vector3,r.subVectors(e,t),i=new THREE.Vector3(0,0,1),o=new THREE.Vector3(1,0,0),r.applyAxisAngle(i,this.genotype.phi),r.applyAxisAngle(o,this.genotype.beta),r.normalize(),r.multiplyScalar(this.genotype.translationFactor),a=new THREE.Vector3,a.copy(e),a.add(r),a},r.prototype.calculateNewRadius=function(){return this.ancestorOrCurrentChamber().radius*this.genotype.growthFactor},r.prototype.calculateNewThickness=function(){return this.ancestorOrCurrentChamber().thickness*this.genotype.wallThicknessFactor},r.prototype.ancestorOrCurrentChamber=function(){return this.currentChamber.ancestor||this.currentChamber},r.prototype.calculateNewAperture=function(t){var e,r,i,o,a,s,n;for(e=t.geometry.vertices,r=e[0],i=r.distanceTo(t.center),n=1;n<e.length;n++)if(o=e[n].distanceTo(t.center),i>o){s=!1;for(var c=0,h=this.chambers;c<h.length;c++)if(a=h[c],a.radius>r.distanceTo(a.center)){s=!0;break}s||(r=e[n],i=o)}return r},r.prototype.buildInitialChamber=function(){var t=this.buildChamber(new THREE.Vector3(0,0,0),r.INITIAL_RADIUS,r.INITIAL_THICKNESS);return this.add(t),t},r.prototype.buildChamber=function(e,r,i){var o=new t.Chamber(e,r,i);return o.material=this.material,o},r.prototype.buildMaterial=function(){return new THREE.MeshLambertMaterial({color:16777215,transparent:!0,opacity:r.INITIAL_OPACITY})},r.INITIAL_RADIUS=5,r.INITIAL_THICKNESS=1,r.INITIAL_OPACITY=.5,r}(THREE.Object3D);t.Foram=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(t){function e(r,i){this.foram=r,this.positionsBuffer=this.buildPositionsBuffer(),this.color=i&&i.color||e.DEFAULT_COLOR,this.width=i&&i.width||e.DEFAULT_WIDTH;var o=this.buildGeometry(),a=this.buildMaterial();t.call(this,o,a),this.rebuild()}return __extends(e,t),e.prototype.buildPath=function(t){var e,r,i;e=this.positionsBuffer.array,r=0;for(var o=0;o<t.length;o++)i=t[o],e[r++]=i.x,e[r++]=i.y,e[r++]=i.z;this.geometry.setDrawRange(0,t.length),this.positionsBuffer.needsUpdate=!0},e.prototype.fetchChambersAttribute=function(t){var e,r,i=[];e=this.filterActiveChambers();for(var o=0;o<e.length;o++)r=e[o],i.push(r[t]);return i},e.prototype.filterActiveChambers=function(){var t,e,r;t=this.foram.chambers,r=[];for(var i=0;i<t.length;i++)e=t[i],e.visible&&r.push(e);return r},e.prototype.buildPositionsBuffer=function(){return new THREE.BufferAttribute(new Float32Array(3*e.MAX_POINTS),3)},e.prototype.buildGeometry=function(){var t=new THREE.BufferGeometry;return t.addAttribute("position",this.positionsBuffer),t},e.prototype.buildMaterial=function(){return new THREE.LineBasicMaterial({color:this.color,linewidth:this.width})},e.MAX_POINTS=100,e.DEFAULT_COLOR=16711680,e.DEFAULT_WIDTH=10,e}(THREE.Line);t.ChamberPath=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.rebuild=function(){var t=this.fetchChambersAttribute("aperture");this.buildPath(t)},e}(t.ChamberPath);t.AperturesPath=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.rebuild=function(){var t=this.fetchChambersAttribute("center");this.buildPath(t)},e}(t.ChamberPath);t.CentroidsPath=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(){function t(t){this.dev=t.dev||!1}return t}();t.Configuration=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(){function t(t){this.foram=t}return t}();t.Calculator=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(){function t(t,e,r){this.va=t,this.vb=e,this.vc=r,this.centroid=this.calculateCentroid()}return t.prototype.calculateCentroid=function(){return this.va.clone().add(this.vb).add(this.vc).divideScalar(3)},t}();t.Face=e}(e=t.Helpers||(t.Helpers={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(e){var r=function(){function e(t){this.foram=t}return e.prototype.sumFaces=function(e){var r,i,o,a,s,n,c,h,u,l,p,d;r=this.foram.chambers,d=0;for(var f=0;f<r.length;f++){i=r[f],a=i.geometry.faces,h=i.geometry.vertices;for(var m=0;m<a.length;m++){s=a[m],u=h[s.a],l=h[s.b],p=h[s.c],n=new t.Helpers.Face(u,l,p),c=!0;for(var v=0;v<r.length;v++)if(o=r[v],o!=i&&n.centroid.distanceTo(o.center)<o.radius){c=!1;break}c&&(d+=e(n))}}return d},e}();e.FacesProcessor=r}(e=t.Calculators||(t.Calculators={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(e){var r=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.prototype.calculate=function(){var t=new e.FacesProcessor(this.foram);return t.sumFaces(this.calculateFaceSurfaceArea)},r.prototype.calculateFaceSurfaceArea=function(t){var e,r,i;return e=t.vb.clone().sub(t.va),r=t.vc.clone().sub(t.va),i=new THREE.Vector3,i.crossVectors(e,r),i.length()/2},r}(t.Calculator);e.SurfaceCalculator=r}(e=t.Calculators||(t.Calculators={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(e){var r=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.prototype.calculate=function(){var t=new e.FacesProcessor(this.foram);return t.sumFaces(this.calculateFaceTetrahedronVolume)},r.prototype.calculateFaceTetrahedronVolume=function(t){var e,r,i,o,a,s;return e=t.vc.x*t.vb.y*t.va.z,r=t.vb.x*t.vc.y*t.va.z,i=t.vc.x*t.va.y*t.vb.z,o=t.va.x*t.vc.y*t.vb.z,a=t.vb.x*t.va.y*t.vc.z,s=t.va.x*t.vb.y*t.vc.z,(-e+r+i-o-a+s)/6},r}(t.Calculator);e.VolumeCalculator=r}(e=t.Calculators||(t.Calculators={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(){function e(e,r){this.canvas=e,this.configuration=new t.Configuration(r),this.thicknessVectorsVisible=!1,this.setupScene(),this.setupControls(),this.setupAutoResize(),this.configuration.dev&&this.setupGUI(),this.animate()}return e.prototype.simulate=function(e,r){this.reset(),this.foram=new t.Foram(e,r),this.scene.add(this.foram)},e.prototype.evolve=function(){this.foram&&(this.foram.evolve(),this.centroidsPath&&this.centroidsPath.rebuild(),this.aperturesPath&&this.aperturesPath.rebuild(),this.updateThicknessVectors())},e.prototype.regress=function(){this.foram&&(this.foram.regress(),this.centroidsPath&&this.centroidsPath.rebuild(),this.aperturesPath&&this.aperturesPath.rebuild())},e.prototype.calculateSurfaceArea=function(){if(this.foram){var e=new t.Calculators.SurfaceCalculator(this.foram);return e.calculate()}},e.prototype.calculateVolume=function(){if(this.foram){var e=new t.Calculators.VolumeCalculator(this.foram);return e.calculate()}},e.prototype.toggleCentroidsPath=function(){this.foram&&(this.centroidsPath||(this.centroidsPath=new t.CentroidsPath(this.foram,{color:16711680}),this.centroidsPath.visible=!1,this.scene.add(this.centroidsPath)),this.centroidsPath.visible=!this.centroidsPath.visible)},e.prototype.toggleAperturesPath=function(){this.foram&&(this.aperturesPath||(this.aperturesPath=new t.AperturesPath(this.foram,{color:65280}),this.aperturesPath.visible=!1,this.scene.add(this.aperturesPath)),this.aperturesPath.visible=!this.aperturesPath.visible)},e.prototype.showThicknessVectors=function(){if(this.foram)for(var t=this.foram.chambers,e=0;e<t.length;e++)t[e].showThicknessVector()},e.prototype.hideThicknessVectors=function(){if(this.foram)for(var t=this.foram.chambers,e=0;e<t.length;e++)t[e].hideThicknessVector()},e.prototype.toggleThicknessVectors=function(){this.thicknessVectorsVisible=!this.thicknessVectorsVisible,this.updateThicknessVectors()},e.prototype.toggleChambers=function(){this.foram.visible=!this.foram.visible},e.prototype.applyOpacity=function(t){this.foram&&(this.foram.material.opacity=t)},e.prototype.exportToOBJ=function(){return this.foram?(new THREE.OBJExporter).parse(this.foram):void 0},e.prototype.updateThicknessVectors=function(){this.thicknessVectorsVisible?this.showThicknessVectors():this.hideThicknessVectors()},e.prototype.reset=function(){this.foram&&this.scene.remove(this.foram),this.centroidsPath&&this.scene.remove(this.centroidsPath),this.aperturesPath&&this.scene.remove(this.aperturesPath),this.thicknessVectorsVisible=!1,this.foram=null,this.centroidsPath=null,this.aperturesPath=null},e.prototype.setupScene=function(){this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,0,70),this.scene.add(this.camera),this.lighting=new THREE.SpotLight(16777215),this.camera.add(this.lighting),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setClearColor(1118481,1),this.renderer.setSize(window.innerWidth,window.innerHeight),this.canvas.appendChild(this.renderer.domElement)},e.prototype.setupControls=function(){this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement),this.controls.rotateSpeed=5,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68]},e.prototype.setupAutoResize=function(){var t=this;window.addEventListener("resize",function(){return t.resize()})},e.prototype.setupGUI=function(){var t=this;this.gui=new dat.GUI;var e=this.gui.addFolder("Genotype"),r=this.gui.addFolder("Structure analyzer"),i=this.gui.addFolder("Material"),o={phi:.5,beta:.5,translationFactor:.5,growthFactor:1.1,wallThicknessFactor:1.1},a={numChambers:7,simulate:function(){return t.simulate(o,a.numChambers)},evolve:function(){return t.evolve()},regress:function(){return t.regress()},centroidsPath:function(){return t.toggleCentroidsPath()},aperturesPath:function(){return t.toggleAperturesPath()},thicknessVectors:function(){return t.toggleThicknessVectors()},toggleChambers:function(){return t.toggleChambers()}},s={opacity:.5};e.add(o,"phi").step(.01),e.add(o,"beta").step(.01),e.add(o,"translationFactor").step(.01),e.add(o,"growthFactor").step(.01),e.add(o,"wallThicknessFactor").step(.01),r.add(a,"numChambers"),r.add(a,"simulate"),r.add(a,"evolve"),r.add(a,"regress"),r.add(a,"centroidsPath"),r.add(a,"aperturesPath"),r.add(a,"thicknessVectors"),r.add(a,"toggleChambers"),i.add(s,"opacity").onFinishChange(function(){return t.applyOpacity(s.opacity)})},e.prototype.resize=function(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)},e.prototype.animate=function(){var t=this;requestAnimationFrame(function(){return t.animate()}),this.controls.update(),this.render()},e.prototype.render=function(){this.renderer.render(this.scene,this.camera)},e}();t.Simulation=e}(Foram3D||(Foram3D={}));