var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)},Foram3D;!function(t){var e=function(t){function e(e,r,i){this.center=e,this.origin=e,this.radius=r,this.thickness=i;var a=this.buildGeometry(),o=this.buildMaterial();t.call(this,a,o),this.aperture=this.calculateAperture()}return __extends(e,t),e.prototype.setAncestor=function(t){this.ancestor=t,this.origin=t.aperture,t.child=this},e.prototype.showThicknessVector=function(){this.thicknessVector||(this.thicknessVector=this.buildThicknessVector(),this.add(this.thicknessVector)),this.thicknessVector.visible=!0},e.prototype.hideThicknessVector=function(){this.thicknessVector&&(this.thicknessVector.visible=!1)},e.prototype.serialize=function(){return{radius:this.radius,thickness:this.thickness}},e.prototype.buildGeometry=function(){var t=new THREE.SphereGeometry(this.radius,e.WIDTH_SEGMENTS,e.HEIGHT_SEGMENTS);return t.applyMatrix((new THREE.Matrix4).makeTranslation(this.center.x,this.center.y,this.center.z)),t},e.prototype.buildMaterial=function(){return new THREE.MeshLambertMaterial({color:16777215,transparent:!0,opacity:.5})},e.prototype.buildThicknessVector=function(){var t=new THREE.Vector3(0,1,0);return new THREE.ArrowHelper(t,this.origin,this.thickness,16776960)},e.prototype.calculateAperture=function(){var t,e,r,i;t=this.geometry.vertices,e=t[0],r=e.distanceTo(this.center);for(var a=1;a<t.length;a++)i=t[a].distanceTo(this.center),r>i&&(e=t[a],r=i);return e},e.WIDTH_SEGMENTS=32,e.HEIGHT_SEGMENTS=32,e}(THREE.Mesh);t.Chamber=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(){function t(t){this.dev=t.dev||!1}return t}();t.Configuration=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(){function t(t){this.foram=t}return t}();t.Calculator=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(){function t(t,e,r){this.va=t,this.vb=e,this.vc=r,this.centroid=this.calculateCentroid()}return t.prototype.calculateCentroid=function(){return this.va.clone().add(this.vb).add(this.vc).divideScalar(3)},t}();t.Face=e}(e=t.Helpers||(t.Helpers={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(e){var r=function(){function e(t){this.foram=t}return e.prototype.sumFaces=function(e){var r,i,a,o,n,s,c,h,u,l,p,m;r=this.foram.getActiveChambers(),m=0;for(var f=0;f<r.length;f++){i=r[f],o=i.geometry.faces,h=i.geometry.vertices;for(var d=0;d<o.length;d++){n=o[d],u=h[n.a],l=h[n.b],p=h[n.c],s=new t.Helpers.Face(u,l,p),c=!0;for(var v=0;v<r.length;v++)if(a=r[v],a!=i&&s.centroid.distanceTo(a.center)<a.radius){c=!1;break}c&&(m+=e(s))}}return m},e}();e.FacesProcessor=r}(e=t.Calculators||(t.Calculators={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(e){var r=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.prototype.calculate=function(){var t=new e.FacesProcessor(this.foram);return t.sumFaces(this.calculateFaceSurfaceArea)},r.prototype.calculateFaceSurfaceArea=function(t){var e,r,i;return e=t.vb.clone().sub(t.va),r=t.vc.clone().sub(t.va),i=new THREE.Vector3,i.crossVectors(e,r),i.length()/2},r}(t.Calculator);e.SurfaceCalculator=r}(e=t.Calculators||(t.Calculators={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(e){var r=function(t){function r(){t.apply(this,arguments)}return __extends(r,t),r.prototype.calculate=function(){var t=new e.FacesProcessor(this.foram);return t.sumFaces(this.calculateFaceTetrahedronVolume)},r.prototype.calculateFaceTetrahedronVolume=function(t){var e,r,i,a,o,n;return e=t.vc.x*t.vb.y*t.va.z,r=t.vb.x*t.vc.y*t.va.z,i=t.vc.x*t.va.y*t.vb.z,a=t.va.x*t.vc.y*t.vb.z,o=t.vb.x*t.va.y*t.vc.z,n=t.va.x*t.vb.y*t.vc.z,(-e+r+i-a-o+n)/6},r}(t.Calculator);e.VolumeCalculator=r}(e=t.Calculators||(t.Calculators={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(e){var r=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.calculate=function(){var t=this.calculateCentroidsPathLength(),e=this.calculateDistanceBetweenHeadAndTail();return t/e},e.prototype.calculateDistanceBetweenHeadAndTail=function(){var t,e,r;return t=this.foram.chambers,e=t[0],r=t[t.length-1],e.center.distanceTo(r.center)},e.prototype.calculateCentroidsPathLength=function(){var t,e,r,i;t=this.foram.getActiveChambers(),e=t[0],t.shift(),i=0;for(var a=0;a<t.length;a++)r=t[a],i+=e.center.distanceTo(r.center),e=r;return i},e}(t.Calculator);e.ShapeFactorCalculator=r}(e=t.Calculators||(t.Calculators={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(e){function r(t,r){e.call(this),this.prevChambers=[],this.genotype=t,this.material=this.buildMaterial();var i=this.buildInitialChamber();this.chambers=[i],this.currentChamber=i,this.prevChambers[0]=i;for(var a=1;r>a;a++)this.evolve()}return __extends(r,e),r.prototype.evolve=function(){var t=this.currentChamber.child;if(t)this.currentChamber=t,this.currentChamber.visible=!0;else{var e=this.calculateNextChamber();this.chambers.push(e),this.currentChamber=e,this.add(e)}},r.prototype.regress=function(){var t=this.currentChamber.ancestor;t&&(this.currentChamber.visible=!1,this.currentChamber=t)},r.prototype.calculateSurfaceArea=function(){var e=new t.Calculators.SurfaceCalculator(this);return e.calculate()},r.prototype.calculateVolume=function(){var e=new t.Calculators.VolumeCalculator(this);return e.calculate()},r.prototype.calculateShapeFactor=function(){var e=new t.Calculators.ShapeFactorCalculator(this);return e.calculate()},r.prototype.getActiveChambers=function(){for(var t,e=[],r=0,i=this.chambers;r<i.length;r++)t=i[r],t.visible&&e.push(t);return e},r.prototype.calculateNextChamber=function(){var t,e,r,i,a;return t=this.calculateNewCenter(),e=this.calculateNewRadius(),r=this.calculateNewThickness(),i=this.buildChamber(t,e,r),a=this.calculateNewAperture(i),i.aperture=a,i.setAncestor(this.currentChamber),this.prevChambers[2]=this.prevChambers[1],this.prevChambers[1]=this.prevChambers[0],this.prevChambers[0]=i,i},r.prototype.calculateNewCenter=function(){var t,e,r,i,a;switch(t=new THREE.Vector3,1==this.chambers.length?t.subVectors(this.prevChambers[0].aperture,this.prevChambers[0].center):t.subVectors(this.prevChambers[0].aperture,this.prevChambers[1].aperture),e=new THREE.Vector3,this.chambers.length){case 1:e.set(0,1,0);break;case 2:e.subVectors(this.prevChambers[1].center,this.prevChambers[1].aperture);break;default:e.subVectors(this.prevChambers[2].aperture,this.prevChambers[1].aperture)}return r=new THREE.Vector3,r.crossVectors(t,e),r.normalize(),i=new THREE.Vector3,i.copy(t),i.applyAxisAngle(r,this.genotype.phi),t.normalize(),i.applyAxisAngle(t,this.genotype.beta),i.normalize(),i.multiplyScalar(this.genotype.translationFactor),a=new THREE.Vector3,a.copy(this.prevChambers[0].aperture),a.add(i),a},r.prototype.calculateNewRadius=function(){return this.currentChamber.radius*this.genotype.growthFactor},r.prototype.calculateNewThickness=function(){return this.currentChamber.thickness*this.genotype.wallThicknessFactor},r.prototype.calculateNewAperture=function(t){var e,r,i,a,o,n,s,c;for(e=t.geometry.vertices,r=this.prevChambers[0].aperture,i=e[0],a=i.distanceTo(r),c=1;c<e.length;c++)if(o=e[c].distanceTo(r),a>o){s=!1;for(var h=0,u=this.chambers;h<u.length;h++)if(n=u[h],n.radius>=e[c].distanceTo(n.center)){s=!0;break}s||(i=e[c],a=o)}return i},r.prototype.buildInitialChamber=function(){var t=this.buildChamber(new THREE.Vector3(0,0,0),r.INITIAL_RADIUS,r.INITIAL_THICKNESS);return this.add(t),t},r.prototype.buildChamber=function(e,r,i){var a=new t.Chamber(e,r,i);return a.material=this.material,a},r.prototype.buildMaterial=function(){return new THREE.MeshLambertMaterial({color:16777215,transparent:!0,opacity:r.INITIAL_OPACITY})},r.INITIAL_RADIUS=5,r.INITIAL_THICKNESS=1,r.INITIAL_OPACITY=.5,r}(THREE.Object3D);t.Foram=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(t){function e(r,i){this.foram=r,this.positionsBuffer=this.buildPositionsBuffer(),this.color=i&&i.color||e.DEFAULT_COLOR,this.width=i&&i.width||e.DEFAULT_WIDTH;var a=this.buildGeometry(),o=this.buildMaterial();t.call(this,a,o),this.rebuild()}return __extends(e,t),e.prototype.buildPath=function(t){var e,r,i;e=this.positionsBuffer.array,r=0;for(var a=0;a<t.length;a++)i=t[a],e[r++]=i.x,e[r++]=i.y,e[r++]=i.z;this.geometry.setDrawRange(0,t.length),this.positionsBuffer.needsUpdate=!0},e.prototype.fetchChambersAttribute=function(t){var e,r,i=[];e=this.foram.getActiveChambers();for(var a=0;a<e.length;a++)r=e[a],i.push(r[t]);return i},e.prototype.buildPositionsBuffer=function(){return new THREE.BufferAttribute(new Float32Array(3*e.MAX_POINTS),3)},e.prototype.buildGeometry=function(){var t=new THREE.BufferGeometry;return t.addAttribute("position",this.positionsBuffer),t},e.prototype.buildMaterial=function(){return new THREE.LineBasicMaterial({color:this.color,linewidth:this.width})},e.MAX_POINTS=100,e.DEFAULT_COLOR=16711680,e.DEFAULT_WIDTH=3,e}(THREE.Line);t.ChamberPath=e}(e=t.ChamberPaths||(t.ChamberPaths={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.rebuild=function(){var t=this.fetchChambersAttribute("center");this.buildPath(t)},e}(t.ChamberPath);t.CentroidsPath=e}(e=t.ChamberPaths||(t.ChamberPaths={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.rebuild=function(){var t=this.fetchChambersAttribute("aperture");this.buildPath(t)},e}(t.ChamberPath);t.AperturesPath=e}(e=t.ChamberPaths||(t.ChamberPaths={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e=function(){function e(e,r){this.canvas=e,this.configuration=new t.Configuration(r),this.thicknessVectorsVisible=!1,this.setupScene(),this.setupControls(),this.setupMouseEvents(),this.setupAutoResize(),this.configuration.dev&&this.setupGUI(),this.animate()}return e.prototype.simulate=function(e,r){this.reset(),this.foram=new t.Foram(e,r),this.scene.add(this.foram)},e.prototype.evolve=function(){this.foram&&(this.foram.evolve(),this.centroidsPath&&this.centroidsPath.rebuild(),this.aperturesPath&&this.aperturesPath.rebuild(),this.updateThicknessVectors())},e.prototype.regress=function(){this.foram&&(this.foram.regress(),this.centroidsPath&&this.centroidsPath.rebuild(),this.aperturesPath&&this.aperturesPath.rebuild())},e.prototype.calculateSurfaceArea=function(){return this.foram?this.foram.calculateSurfaceArea():void 0},e.prototype.calculateVolume=function(){return this.foram?this.foram.calculateVolume():void 0},e.prototype.calculateShapeFactor=function(){return this.foram?this.foram.calculateShapeFactor():void 0},e.prototype.toggleCentroidsPath=function(){this.foram&&(this.centroidsPath||(this.centroidsPath=new t.ChamberPaths.CentroidsPath(this.foram,{color:16711680}),this.centroidsPath.visible=!1,this.scene.add(this.centroidsPath)),this.centroidsPath.visible=!this.centroidsPath.visible)},e.prototype.toggleAperturesPath=function(){this.foram&&(this.aperturesPath||(this.aperturesPath=new t.ChamberPaths.AperturesPath(this.foram,{color:65280}),this.aperturesPath.visible=!1,this.scene.add(this.aperturesPath)),this.aperturesPath.visible=!this.aperturesPath.visible)},e.prototype.showThicknessVectors=function(){if(this.foram)for(var t=this.foram.chambers,e=0;e<t.length;e++)t[e].showThicknessVector()},e.prototype.hideThicknessVectors=function(){if(this.foram)for(var t=this.foram.chambers,e=0;e<t.length;e++)t[e].hideThicknessVector()},e.prototype.toggleThicknessVectors=function(){this.thicknessVectorsVisible=!this.thicknessVectorsVisible,this.updateThicknessVectors()},e.prototype.toggleChambers=function(){this.foram.visible=!this.foram.visible},e.prototype.applyOpacity=function(t){this.foram&&(this.foram.material.opacity=t)},e.prototype.exportToOBJ=function(){return this.foram?(new THREE.OBJExporter).parse(this.foram):void 0},e.prototype.exportToCSV=function(){return this.foram?(new t.Export.CSVExporter).parse(this.foram):void 0},e.prototype.onChamberClick=function(t){this._onChamberClick=t},e.prototype.onChamberHover=function(t){this._onChamberHover=t},e.prototype.updateThicknessVectors=function(){this.thicknessVectorsVisible?this.showThicknessVectors():this.hideThicknessVectors()},e.prototype.reset=function(){this.foram&&this.scene.remove(this.foram),this.centroidsPath&&this.scene.remove(this.centroidsPath),this.aperturesPath&&this.scene.remove(this.aperturesPath),this.thicknessVectorsVisible=!1,this.foram=null,this.centroidsPath=null,this.aperturesPath=null},e.prototype.setupScene=function(){this.scene=new THREE.Scene;var t=this.canvas.clientWidth,e=this.canvas.clientHeight;this.camera=new THREE.PerspectiveCamera(45,t/e,.1,1e3),this.camera.position.set(0,0,70),this.scene.add(this.camera),this.lighting=new THREE.SpotLight(16777215),this.camera.add(this.lighting),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setClearColor(1118481,1),this.renderer.setSize(t,e),this.canvas.appendChild(this.renderer.domElement)},e.prototype.setupControls=function(){this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement),this.controls.rotateSpeed=5,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68]},e.prototype.setupMouseEvents=function(){var t=this;this.renderer.domElement.addEventListener("click",function(e){return t.onMouseClick(e)}),this.renderer.domElement.addEventListener("mousemove",function(e){return t.onMouseMove(e)})},e.prototype.setupAutoResize=function(){var t=this;window.addEventListener("resize",function(){return t.resize()})},e.prototype.setupGUI=function(){var t=this;this.gui=new dat.GUI;var e=this.gui.addFolder("Genotype"),r=this.gui.addFolder("Structure analyzer"),i=this.gui.addFolder("Material"),a={phi:.5,beta:.5,translationFactor:.5,growthFactor:1.1,wallThicknessFactor:1.1},o={numChambers:20,simulate:function(){return t.simulate(a,o.numChambers)},evolve:function(){return t.evolve()},regress:function(){return t.regress()},centroidsPath:function(){return t.toggleCentroidsPath()},aperturesPath:function(){return t.toggleAperturesPath()},thicknessVectors:function(){return t.toggleThicknessVectors()},toggleChambers:function(){return t.toggleChambers()}},n={opacity:.5};e.add(a,"phi").step(.01),e.add(a,"beta").step(.01),e.add(a,"translationFactor").step(.01),e.add(a,"growthFactor").step(.01),e.add(a,"wallThicknessFactor").step(.01),r.add(o,"numChambers"),r.add(o,"simulate"),r.add(o,"evolve"),r.add(o,"regress"),r.add(o,"centroidsPath"),r.add(o,"aperturesPath"),r.add(o,"thicknessVectors"),r.add(o,"toggleChambers"),i.add(n,"opacity").onFinishChange(function(){return t.applyOpacity(n.opacity)})},e.prototype.onMouseClick=function(t){if(t.preventDefault(),this._onChamberClick){var e=this.getPointedChamber(t);e&&this._onChamberClick(t,e)}},e.prototype.onMouseMove=function(t){if(t.preventDefault(),this._onChamberHover){var e=this.getPointedChamber(t);e&&this._onChamberHover(t,e)}},e.prototype.getPointedChamber=function(t){if(this.foram){var e=new THREE.Raycaster,r=new THREE.Vector2;r.x=t.clientX/this.renderer.domElement.clientWidth*2-1,r.y=2*-(t.clientY/this.renderer.domElement.clientHeight)+1,e.setFromCamera(r,this.camera);var i=e.intersectObjects(this.foram.chambers);return i.length>0?i[0].object:void 0}},e.prototype.resize=function(){var t=this.canvas.clientWidth,e=this.canvas.clientHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)},e.prototype.animate=function(){var t=this;requestAnimationFrame(function(){return t.animate()}),this.controls.update(),this.render()},e.prototype.render=function(){this.renderer.render(this.scene,this.camera)},e}();t.Simulation=e}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(){function t(){}return t.prototype.parse=function(t){var e=[];for(var r in t.genotype)e.push(t.genotype[r]);return e.push(t.calculateSurfaceArea(),t.calculateVolume(),t.calculateShapeFactor()),e.join(";")},t}();t.CSVExporter=e}(e=t.Export||(t.Export={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(t){function e(r,i,a){this.start=r,this.end=i,this.color=a.color||e.DEFAULT_COLOR,this.length=a.length||e.DEFAULT_LENGTH;var o=this.buildGeometry(),n=this.buildMaterial();t.call(this,o,n)}return __extends(e,t),e.prototype.buildGeometry=function(){var t,e,r,i;return t=new THREE.Geometry,e=new THREE.Vector3,e.subVectors(this.start,this.end),e.normalize(),r=new THREE.Vector3,r.addVectors(this.start,e.multiplyScalar(this.length)),i=new THREE.Vector3,i.addVectors(this.end,e.negate()),t.vertices.push(r,i),t},e.prototype.buildMaterial=function(){return new THREE.LineBasicMaterial({color:this.color})},e.DEFAULT_COLOR=16711680,e.DEFAULT_LENGTH=2.5,e}(THREE.Line);t.Line=e}(e=t.Helpers||(t.Helpers={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(t){function e(r,i,a,o){this.position=(new THREE.Vector3).copy(r),this.spanningVector1=(new THREE.Vector3).copy(i),this.spanningVector2=(new THREE.Vector3).copy(a),this.color=o.color||e.DEFAULT_COLOR,this.size=o.size||e.DEFAULT_SIZE,this.normalizeSpanningVectors();var n=this.buildGeometry(),s=this.buildMaterial();t.call(this,n,s)}return __extends(e,t),e.prototype.normalizeSpanningVectors=function(){this.spanningVector1.normalize().multiplyScalar(this.size),this.spanningVector2.normalize().multiplyScalar(this.size)},e.prototype.buildGeometry=function(){var t,e,r,i,a;return t=new THREE.Geometry,e=(new THREE.Vector3).copy(this.position),r=(new THREE.Vector3).copy(this.position),i=(new THREE.Vector3).copy(this.position),a=(new THREE.Vector3).copy(this.position),e.add(this.spanningVector1),r.add(this.spanningVector2),i.sub(this.spanningVector1),a.sub(this.spanningVector2),t.vertices.push(e,r,i,a),t.faces.push(new THREE.Face3(0,1,2),new THREE.Face3(0,2,3)),t},e.prototype.buildMaterial=function(){return new THREE.MeshBasicMaterial({side:THREE.DoubleSide,color:this.color,transparent:!0,opacity:e.DEFAULT_OPACITY})},e.DEFAULT_COLOR=16711680,e.DEFAULT_SIZE=10,e.DEFAULT_OPACITY=.3,e}(THREE.Mesh);t.Plane=e}(e=t.Helpers||(t.Helpers={}))}(Foram3D||(Foram3D={}));var Foram3D;!function(t){var e;!function(t){var e=function(t){function e(r,i){this.color=i.color||e.DEFAULT_COLOR,this.size=i.size||e.DEFAULT_SIZE;var a=this.buildGeometry(),o=this.buildMaterial();t.call(this,a,o),this.position.copy(r)}return __extends(e,t),e.prototype.buildGeometry=function(){return new THREE.SphereGeometry(this.size,e.WIDTH_SEGMENTS,e.HEIGHT_SEGMENTS)},e.prototype.buildMaterial=function(){return new THREE.MeshLambertMaterial({color:this.color})},e.DEFAULT_SIZE=.3,e.DEFAULT_COLOR=16711680,e.WIDTH_SEGMENTS=32,e.HEIGHT_SEGMENTS=32,e}(THREE.Mesh);t.Point=e}(e=t.Helpers||(t.Helpers={}))}(Foram3D||(Foram3D={}));