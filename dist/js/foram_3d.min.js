var CentroidsLine,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;CentroidsLine=function(t){function e(t){this.foram=t,this.positionsBuffer=this.buildPositionsBuffer(),this.geometry=this.buildLineGometry(),this.material=this.buildLineMaterial(),this.rebuild(),THREE.Line.call(this,this.geometry,this.material)}return extend(e,t),e.prototype.MAX_POINTS=100,e.prototype.buildPositionsBuffer=function(){var t;return t=new Float32Array(3*this.MAX_POINTS),new THREE.BufferAttribute(t,3)},e.prototype.buildLineGometry=function(){var t;return t=new THREE.BufferGeometry,t.addAttribute("position",this.positionsBuffer),t},e.prototype.buildLineMaterial=function(){return new THREE.LineBasicMaterial({color:16711680,linewidth:10})},e.prototype.rebuild=function(){var t,e,r,i,n,s,o;for(t=this.filterActiveChambers(),o=this.positionsBuffer.array,n=0,i=0,s=t.length;s>i;i++)r=t[i],e=r.center,o[n++]=e.x,o[n++]=e.y,o[n++]=e.z;return this.geometry.setDrawRange(0,t.length),this.positionsBuffer.needsUpdate=!0},e.prototype.filterActiveChambers=function(){var t,e,r,i,n;for(i=this.foram.chambers,n=[],e=0,r=i.length;r>e;e++)t=i[e],t.visible&&n.push(t);return n},e}(THREE.Line);var Chamber,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Chamber=function(t){function e(t,e,r,i){var n;this.center=t,this.radius=e,this.thickness=r,n=this.buildChamberGeometry(),THREE.Mesh.call(this,n,i),this.vertices=n.vertices,this.origin=this.center,this.aperture=this.calculateAperture(),this.thicknessVector=this.buildThicknessVector(),this.add(this.thicknessVector)}return extend(e,t),e.prototype.DEFAULT_TEXTURE="../assets/images/texture.gif",e.prototype.GROWTH_VECTOR_COLOR=16776960,e.prototype.buildChamberGeometry=function(){var t,e;return t=this.buildCenterTranslationMatrix(),e=new THREE.SphereGeometry(this.radius,32,32),e.applyMatrix(t),e},e.prototype.buildCenterTranslationMatrix=function(){return(new THREE.Matrix4).makeTranslation(this.center.x,this.center.y,this.center.z)},e.prototype.calculateAperture=function(){var t,e,r,i,n,s,o;for(t=this.vertices[0],e=t.distanceTo(this.center),s=this.vertices.slice(1),r=0,i=s.length;i>r;r++)o=s[r],n=o.distanceTo(this.center),e>n&&(t=o,e=n);return t},e.prototype.setAperture=function(t){return this.aperture=t},e.prototype.setAncestor=function(t){return this.ancestor=t,t?(t&&(this.origin=t.aperture),t.child=this):void 0},e.prototype.calculateGeometryRing=function(){var t,e,r,i,n;for(r=this.geometry.vertices,i=[],t=0,e=r.length;e>t;t++)n=r[t],0===n.z&&i.push(n);return i},e.prototype.buildThicknessVector=function(){var t,e;return t=new THREE.Vector3(0,1,0),e=new THREE.ArrowHelper(t,this.origin,this.thickness,this.GROWTH_VECTOR_COLOR),e.visible=!1,e},e.prototype.showThicknessVector=function(){return this.thicknessVector.visible=!0},e.prototype.hideThicknessVector=function(){return this.thicknessVector.visible=!1},e.prototype.toggleThicknessVector=function(){return this.thicknessVector.visible!==this.thicknessVector.visible},e}(THREE.Mesh);var Foram,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Foram=function(t){function e(t){var e;this.genotype=t,THREE.Object3D.call(this),this.material=this.buildChamberMaterial(),e=this.buildInitialChamber(),this.chambers=[e],this.currentChamber=e}return extend(e,t),e.prototype.INITIAL_RADIUS=5,e.prototype.INITIAL_THICKNESS=3,e.prototype.buildChamberMaterial=function(){return new THREE.MeshLambertMaterial({color:16777215,transparent:!0})},e.prototype.buildInitialChamber=function(){return this.buildChamber(new THREE.Vector3(0,0,0),this.INITIAL_RADIUS,this.INITIAL_THICKNESS)},e.prototype.buildChamber=function(t,e,r){return new Chamber(t,e,r,this.material)},e.prototype.buildChambers=function(t){var e,r,i;for(e=r=1,i=t-1;i>=1?i>=r:r>=i;e=i>=1?++r:--r)this.calculateNextChamber();return this.build()},e.prototype.evolve=function(){var t;return t=this.currentChamber.child,t?(this.currentChamber=t,this.currentChamber.visible=!0):(this.calculateNextChamber(),this.build())},e.prototype.regress=function(){var t;return t=this.currentChamber.ancestor,t?(this.currentChamber.visible=!1,this.currentChamber=t):void 0},e.prototype.calculateNextChamber=function(){var t,e,r,i,n;return e=this.calculateNewCenter(),i=this.calculateNewRadius(),n=this.calculateNewThickness(),r=this.buildChamber(e,i,n),t=this.calculateNewAperture(r),r.setAperture(t),r.setAncestor(this.currentChamber),this.chambers.push(r),this.currentChamber=r},e.prototype.calculateNewCenter=function(){var t,e,r,i,n,s;return e=this.currentChamber.origin,t=this.currentChamber.aperture,r=new THREE.Vector3,r.subVectors(t,e),i=new THREE.Vector3(0,0,1),s=new THREE.Vector3(1,0,0),r.applyAxisAngle(i,this.genotype.phi),r.applyAxisAngle(s,this.genotype.beta),r.normalize(),r.multiplyScalar(this.genotype.translationFactor),n=new THREE.Vector3,n.copy(t),n.add(r),n},e.prototype.calculateNewRadius=function(){return this.ancestorOrCurrentChamber().radius*this.genotype.growthFactor},e.prototype.calculateNewThickness=function(){return this.ancestorOrCurrentChamber().thickness*this.genotype.wallThicknessFactor},e.prototype.ancestorOrCurrentChamber=function(){return this.currentChamber.ancestor||this.currentChamber},e.prototype.calculateNewAperture=function(t){var e,r,i,n,s,o,a,h,c,u,p,l,d;for(c=t.center,h=t.vertices[0],i=h.distanceTo(c),p=t.vertices.slice(1),n=0,o=p.length;o>n;n++)if(d=p[n],u=d.distanceTo(c),i>u){for(r=!1,l=this.chambers,s=0,a=l.length;a>s;s++)if(e=l[s],e.radius>h.distanceTo(e.center)){r=!0;break}r||(h=d,i=u)}return h},e.prototype.build=function(){var t,e,r,i,n;for(i=this.chambers,n=[],e=0,r=i.length;r>e;e++)t=i[e],n.push(this.add(t));return n},e}(THREE.Object3D);var Simulation,bind=function(t,e){return function(){return t.apply(e,arguments)}};Simulation=function(){function t(t,e){var r,i,n;this.canvas=t,this.options=e,this.animate=bind(this.animate,this),i={dev:!1},this.options||(this.options={});for(n in i)(r=this.options)[n]||(r[n]=i[n]);this.setupScene(),this.setupControls(),this.setupAutoResize(),this.options.dev&&this.setupGUI(),this.thicknessVectorsVisible=!1}return t.prototype.setupScene=function(){var t;return this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,0,70),this.scene.add(this.camera),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setClearColor(1118481,1),this.renderer.setSize(window.innerWidth,window.innerHeight),t=new THREE.SpotLight(16777215),this.camera.add(t),this.canvas.append(this.renderer.domElement)},t.prototype.setupControls=function(){return this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement),this.controls.rotateSpeed=5,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68]},t.prototype.setupAutoResize=function(){return window.addEventListener("resize",function(t){return function(){return t.resize()}}(this))},t.prototype.setupGUI=function(){var t,e,r,i,n,s,o;return this.gui=new dat.GUI,e=this.gui.addFolder("Genotype"),o=this.gui.addFolder("Structure analyzer"),r=this.gui.addFolder("Material"),t={phi:.5,beta:.5,translationFactor:.5,growthFactor:1.1,wallThicknessFactor:1.1},n={numChambers:7},s={simulate:function(e){return function(){return e.simulate(t,n)}}(this),evolve:function(t){return function(){return t.evolve()}}(this),regress:function(t){return function(){return t.regress()}}(this),centroidsLine:function(t){return function(){return t.toggleCentroidsLine()}}(this),thicknessVectors:function(t){return function(){return t.toggleThicknessVectors()}}(this),toggleChambers:function(t){return function(){return t.toggleChambers()}}(this)},i={opacity:1},e.add(t,"phi").step(.01),e.add(t,"beta").step(.01),e.add(t,"translationFactor").step(.01),e.add(t,"growthFactor").step(.01),e.add(t,"wallThicknessFactor").step(.01),e.add(n,"numChambers"),o.add(s,"simulate"),o.add(s,"evolve"),o.add(s,"regress"),o.add(s,"centroidsLine"),o.add(s,"thicknessVectors"),o.add(s,"toggleChambers"),r.add(i,"opacity").onFinishChange(function(t){return function(){return t.applyOpacity(i.opacity)}}(this))},t.prototype.simulate=function(t,e){return this.reset(),this.foram=new Foram(t),this.foram.buildChambers(e.numChambers),this.scene.add(this.foram)},t.prototype.evolve=function(){return this.foram?(this.foram.evolve(),this.centroidsLine&&this.centroidsLine.rebuild(),this.updateThicknessVectors()):void 0},t.prototype.regress=function(){return this.foram?(this.foram.regress(),this.centroidsLine?this.centroidsLine.rebuild():void 0):void 0},t.prototype.toggleCentroidsLine=function(){return this.foram?(this.centroidsLine||(this.centroidsLine=new CentroidsLine(this.foram),this.centroidsLine.visible=!1,this.scene.add(this.centroidsLine)),this.centroidsLine.visible=!this.centroidsLine.visible):void 0},t.prototype.showThicknessVectors=function(){var t,e,r,i,n;if(this.foram){for(i=this.foram.chambers,n=[],e=0,r=i.length;r>e;e++)t=i[e],n.push(t.showThicknessVector());return n}},t.prototype.hideThicknessVectors=function(){var t,e,r,i,n;if(this.foram){for(i=this.foram.chambers,n=[],e=0,r=i.length;r>e;e++)t=i[e],n.push(t.hideThicknessVector());return n}},t.prototype.toggleThicknessVectors=function(){return this.thicknessVectorsVisible=!this.thicknessVectorsVisible,this.updateThicknessVectors()},t.prototype.updateThicknessVectors=function(){return this.thicknessVectorsVisible?this.showThicknessVectors():this.hideThicknessVectors()},t.prototype.toggleChambers=function(){return this.foram?this.foram.visible=!this.foram.visible:void 0},t.prototype.applyOpacity=function(t){return this.foram?this.foram.material.opacity=t:void 0},t.prototype.exportToObj=function(){var t;if(this.foram)return t=new THREE.OBJExporter,t.parse(this.foram)},t.prototype.reset=function(){return this.foram&&this.scene.remove(this.foram),this.centroidsLine&&this.scene.remove(this.centroidsLine),this.foram=null,this.centroidsLine=null},t.prototype.animate=function(){return requestAnimationFrame(this.animate),this.controls.update(),this.render()},t.prototype.render=function(){return this.renderer.render(this.scene,this.camera)},t.prototype.resize=function(){return this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)},t}();