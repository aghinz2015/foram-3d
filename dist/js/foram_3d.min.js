var Chamber,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Chamber=function(t){function e(t,e){var r,i;this.center=t,this.radius=e,r=this.buildChamberGeometry(),i=this.buildChamberMaterial(),THREE.Mesh.call(this,r,i),this.vertices=r.vertices,this.origin=this.center,this.aperture=this.calculateAperture()}return extend(e,t),e.prototype.DEFAULT_TEXTURE="../assets/images/texture.gif",e.prototype.buildChamberGeometry=function(){var t,e;return t=this.buildCenterTranslationMatrix(),e=new THREE.SphereGeometry(this.radius,32,32),e.applyMatrix(t),e},e.prototype.buildChamberMaterial=function(){return new THREE.MeshLambertMaterial({color:16777215})},e.prototype.buildCenterTranslationMatrix=function(){return(new THREE.Matrix4).makeTranslation(this.center.x,this.center.y,this.center.z)},e.prototype.calculateAperture=function(){var t,e,r,i,n,s,o;for(t=this.vertices[0],e=t.distanceTo(this.center),s=this.vertices.slice(1),r=0,i=s.length;i>r;r++)o=s[r],n=o.distanceTo(this.center),e>n&&(t=o,e=n);return t},e.prototype.setAperture=function(t){return this.aperture=t},e.prototype.setAncestor=function(t){return this.ancestor=t,t?(t&&(this.origin=t.aperture),t.child=this):void 0},e.prototype.calculateGeometryRing=function(){var t,e,r,i,n;for(r=this.geometry.vertices,i=[],t=0,e=r.length;e>t;t++)n=r[t],0===n.z&&i.push(n);return i},e}(THREE.Mesh);var Foram,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Foram=function(t){function e(t){var e;this.genotype=t,THREE.Object3D.call(this),e=this.buildInitialChamber(),this.chambers=[e],this.currentChamber=e}return extend(e,t),e.prototype.buildInitialChamber=function(){return new Chamber(new THREE.Vector3(0,0,0),this.genotype.initialRadius)},e.prototype.buildChambers=function(t){var e,r,i;for(e=r=1,i=t-1;i>=1?i>=r:r>=i;e=i>=1?++r:--r)this.calculateNextChamber();return this.build()},e.prototype.evolve=function(){var t;return t=this.currentChamber.child,t?(this.currentChamber=t,this.currentChamber.visible=!0):(this.calculateNextChamber(),this.build())},e.prototype.regress=function(){var t;return t=this.currentChamber.ancestor,t?(this.currentChamber.visible=!1,this.currentChamber=t):void 0},e.prototype.calculateNextChamber=function(){var t,e,r,i;return e=this.calculateNewCenter(),i=this.calculateNewRadius(),r=new Chamber(e,i),t=this.calculateNewAperture(r),r.setAperture(t),r.setAncestor(this.currentChamber),this.chambers.push(r),this.currentChamber=r},e.prototype.calculateNewCenter=function(){var t,e,r,i,n,s;return e=this.currentChamber.origin,t=this.currentChamber.aperture,r=new THREE.Vector3,r.subVectors(t,e),i=new THREE.Vector3(0,0,1),s=new THREE.Vector3(1,0,0),r.applyAxisAngle(i,this.genotype.phi),r.applyAxisAngle(s,this.genotype.beta),r.normalize(),r.multiplyScalar(this.genotype.translationFactor),n=new THREE.Vector3,n.copy(t),n.add(r),n},e.prototype.calculateNewRadius=function(){return(this.currentChamber.ancestor||this.currentChamber).radius*this.genotype.growthFactor},e.prototype.calculateNewAperture=function(t){var e,r,i,n,s,o,a,h,u,c,p,l,d;for(u=t.center,h=t.vertices[0],i=h.distanceTo(u),p=t.vertices.slice(1),n=0,o=p.length;o>n;n++)if(d=p[n],c=d.distanceTo(u),i>c){for(r=!1,l=this.chambers,s=0,a=l.length;a>s;s++)if(e=l[s],e.radius>h.distanceTo(e.center)){r=!0;break}r||(h=d,i=c)}return h},e.prototype.build=function(){var t,e,r,i,n;for(i=this.chambers,n=[],e=0,r=i.length;r>e;e++)t=i[e],n.push(this.add(t));return n},e}(THREE.Object3D);var Simulation,bind=function(t,e){return function(){return t.apply(e,arguments)}};Simulation=function(){function t(t){this.canvas=t,this.animate=bind(this.animate,this),this.setupScene(),this.setupControls(),this.setupGUI()}return t.prototype.setupScene=function(){var t;return this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,0,70),this.scene.add(this.camera),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setClearColor(1118481,1),this.renderer.setSize(window.innerWidth,window.innerHeight),t=new THREE.SpotLight(16777215),this.camera.add(t),this.canvas.append(this.renderer.domElement)},t.prototype.setupControls=function(){return this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement),this.controls.rotateSpeed=5,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68]},t.prototype.setupGUI=function(){var t,e;return this.gui=new dat.GUI,t={phi:.5,beta:.5,translationFactor:.5,growthFactor:1.1,initialRadius:5,numChambers:7,simulate:function(e){return function(){return e.simulate(t)}}(this)},e={evolve:function(t){return function(){return t.foram.evolve()}}(this),regress:function(t){return function(){return t.foram.regress()}}(this)},this.gui.add(t,"phi").step(.01),this.gui.add(t,"beta").step(.01),this.gui.add(t,"translationFactor").step(.01),this.gui.add(t,"growthFactor").step(.01),this.gui.add(t,"initialRadius"),this.gui.add(t,"numChambers"),this.gui.add(t,"simulate"),this.gui.add(e,"evolve"),this.gui.add(e,"regress")},t.prototype.simulate=function(t){return this.foram&&this.scene.remove(this.foram),this.foram=new Foram(t),this.foram.buildChambers(t.numChambers),this.scene.add(this.foram)},t.prototype.animate=function(){return requestAnimationFrame(this.animate),this.controls.update(),this.render()},t.prototype.render=function(){return this.renderer.render(this.scene,this.camera)},t}();