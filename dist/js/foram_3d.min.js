var CentroidsLine,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;CentroidsLine=function(t){function e(t){this.foram=t,this.positionsBuffer=this.buildPositionsBuffer(),this.geometry=this.buildLineGometry(this.positionsBuffer),this.material=this.buildLineMaterial(),this.rebuild(),THREE.Line.call(this,this.geometry,this.material)}return extend(e,t),e.prototype.MAX_POINTS=100,e.prototype.buildPositionsBuffer=function(){var t;return t=new Float32Array(3*this.MAX_POINTS),new THREE.BufferAttribute(t,3)},e.prototype.buildLineGometry=function(t){var e;return e=new THREE.BufferGeometry,e.addAttribute("position",t),e},e.prototype.buildLineMaterial=function(){return new THREE.LineBasicMaterial({color:16711680,linewidth:10})},e.prototype.rebuild=function(){var t,e,r,i,n,o,s;for(t=this.filterActiveChambers(),s=this.positionsBuffer.array,n=0,i=0,o=t.length;o>i;i++)r=t[i],e=r.center,s[n++]=e.x,s[n++]=e.y,s[n++]=e.z;return this.geometry.setDrawRange(0,t.length),this.positionsBuffer.needsUpdate=!0},e.prototype.filterActiveChambers=function(){var t,e,r,i,n;for(i=this.foram.chambers,n=[],e=0,r=i.length;r>e;e++)t=i[e],t.visible&&n.push(t);return n},e}(THREE.Line);var Chamber,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Chamber=function(t){function e(t,e){var r,i;this.center=t,this.radius=e,r=this.buildChamberGeometry(),i=this.buildChamberMaterial(),THREE.Mesh.call(this,r,i),this.vertices=r.vertices,this.origin=this.center,this.aperture=this.calculateAperture()}return extend(e,t),e.prototype.DEFAULT_TEXTURE="../assets/images/texture.gif",e.prototype.buildChamberGeometry=function(){var t,e;return t=this.buildCenterTranslationMatrix(),e=new THREE.SphereGeometry(this.radius,32,32),e.applyMatrix(t),e},e.prototype.buildChamberMaterial=function(){return new THREE.MeshLambertMaterial({color:16777215})},e.prototype.buildCenterTranslationMatrix=function(){return(new THREE.Matrix4).makeTranslation(this.center.x,this.center.y,this.center.z)},e.prototype.calculateAperture=function(){var t,e,r,i,n,o,s;for(t=this.vertices[0],e=t.distanceTo(this.center),o=this.vertices.slice(1),r=0,i=o.length;i>r;r++)s=o[r],n=s.distanceTo(this.center),e>n&&(t=s,e=n);return t},e.prototype.setAperture=function(t){return this.aperture=t},e.prototype.setAncestor=function(t){return this.ancestor=t,t?(t&&(this.origin=t.aperture),t.child=this):void 0},e.prototype.calculateGeometryRing=function(){var t,e,r,i,n;for(r=this.geometry.vertices,i=[],t=0,e=r.length;e>t;t++)n=r[t],0===n.z&&i.push(n);return i},e}(THREE.Mesh);var Foram,extend=function(t,e){function r(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;Foram=function(t){function e(t){var e;this.genotype=t,THREE.Object3D.call(this),e=this.buildInitialChamber(),this.chambers=[e],this.currentChamber=e}return extend(e,t),e.prototype.INITIAL_RADIUS=5,e.prototype.buildInitialChamber=function(){return new Chamber(new THREE.Vector3(0,0,0),this.INITIAL_RADIUS)},e.prototype.buildChambers=function(t){var e,r,i;for(e=r=1,i=t-1;i>=1?i>=r:r>=i;e=i>=1?++r:--r)this.calculateNextChamber();return this.build()},e.prototype.evolve=function(){var t;return t=this.currentChamber.child,t?(this.currentChamber=t,this.currentChamber.visible=!0):(this.calculateNextChamber(),this.build())},e.prototype.regress=function(){var t;return t=this.currentChamber.ancestor,t?(this.currentChamber.visible=!1,this.currentChamber=t):void 0},e.prototype.calculateNextChamber=function(){var t,e,r,i;return e=this.calculateNewCenter(),i=this.calculateNewRadius(),r=new Chamber(e,i),t=this.calculateNewAperture(r),r.setAperture(t),r.setAncestor(this.currentChamber),this.chambers.push(r),this.currentChamber=r},e.prototype.calculateNewCenter=function(){var t,e,r,i,n,o;return e=this.currentChamber.origin,t=this.currentChamber.aperture,r=new THREE.Vector3,r.subVectors(t,e),i=new THREE.Vector3(0,0,1),o=new THREE.Vector3(1,0,0),r.applyAxisAngle(i,this.genotype.phi),r.applyAxisAngle(o,this.genotype.beta),r.normalize(),r.multiplyScalar(this.genotype.translationFactor),n=new THREE.Vector3,n.copy(t),n.add(r),n},e.prototype.calculateNewRadius=function(){return(this.currentChamber.ancestor||this.currentChamber).radius*this.genotype.growthFactor},e.prototype.calculateNewAperture=function(t){var e,r,i,n,o,s,a,h,u,c,p,l,d;for(u=t.center,h=t.vertices[0],i=h.distanceTo(u),p=t.vertices.slice(1),n=0,s=p.length;s>n;n++)if(d=p[n],c=d.distanceTo(u),i>c){for(r=!1,l=this.chambers,o=0,a=l.length;a>o;o++)if(e=l[o],e.radius>h.distanceTo(e.center)){r=!0;break}r||(h=d,i=c)}return h},e.prototype.build=function(){var t,e,r,i,n;for(i=this.chambers,n=[],e=0,r=i.length;r>e;e++)t=i[e],n.push(this.add(t));return n},e}(THREE.Object3D);var Simulation,bind=function(t,e){return function(){return t.apply(e,arguments)}};Simulation=function(){function t(t,e){var r,i,n;this.canvas=t,this.options=e,this.animate=bind(this.animate,this),i={dev:!1},this.options||(this.options={});for(n in i)(r=this.options)[n]||(r[n]=i[n]);this.setupScene(),this.setupControls(),this.options.dev&&this.setupGUI()}return t.prototype.setupScene=function(){var t;return this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,0,70),this.scene.add(this.camera),this.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0}),this.renderer.setClearColor(1118481,1),this.renderer.setSize(window.innerWidth,window.innerHeight),t=new THREE.SpotLight(16777215),this.camera.add(t),this.canvas.append(this.renderer.domElement)},t.prototype.setupControls=function(){return this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement),this.controls.rotateSpeed=5,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68]},t.prototype.setupGUI=function(){var t,e,r;return this.gui=new dat.GUI,t={phi:.5,beta:.5,translationFactor:.5,growthFactor:1.1},e={numChambers:7},r={simulate:function(r){return function(){return r.simulate(t,e)}}(this),evolve:function(t){return function(){return t.evolve()}}(this),regress:function(t){return function(){return t.regress()}}(this),centroidsLine:function(t){return function(){return t.toggleCentroidsLine()}}(this)},this.gui.add(t,"phi").step(.01),this.gui.add(t,"beta").step(.01),this.gui.add(t,"translationFactor").step(.01),this.gui.add(t,"growthFactor").step(.01),this.gui.add(e,"numChambers"),this.gui.add(r,"simulate"),this.gui.add(r,"evolve"),this.gui.add(r,"regress"),this.gui.add(r,"centroidsLine")},t.prototype.simulate=function(t,e){return this.foram&&this.scene.remove(this.foram),this.foram=new Foram(t),this.foram.buildChambers(e.numChambers),this.scene.add(this.foram)},t.prototype.evolve=function(){return this.foram?(this.foram.evolve(),this.centroidsLine?this.centroidsLine.rebuild():void 0):void 0},t.prototype.regress=function(){return this.foram?(this.foram.regress(),this.centroidsLine?this.centroidsLine.rebuild():void 0):void 0},t.prototype.toggleCentroidsLine=function(){return this.foram?(this.centroidsLine||(this.centroidsLine=new CentroidsLine(this.foram),this.centroidsLine.visible=!1,this.scene.add(this.centroidsLine)),this.centroidsLine.visible=!this.centroidsLine.visible):void 0},t.prototype.animate=function(){return requestAnimationFrame(this.animate),this.controls.update(),this.render()},t.prototype.render=function(){return this.renderer.render(this.scene,this.camera)},t}();